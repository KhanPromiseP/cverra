generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Provider {
  email
  github
  google
  openid
}

enum Visibility {
  public
  private
}

// Add Role enum
enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum AIBuilderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AIBuilderSource {
  TEXT
  PDF
  DOC
  LINKEDIN
}


// Add to enums
enum ContactSubject {
  SUPPORT
  BILLING
  FEEDBACK
  BUSINESS
  OTHER
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESPONDED
  CLOSED
}


enum CategoryTranslationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}



// Update User model to include role AND article relations
model User {
  id               String   @id @default(cuid())
  name             String
  picture          String?
  username         String   @unique
  email            String   @unique
  locale           String   @default("en-US")
  emailVerified    Boolean  @default(false)
  twoFactorEnabled Boolean  @default(false)
  role             Role     @default(USER)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  provider         Provider
  secrets          Secrets?
  resumes          Resume[]

  coverLetters CoverLetter[] // <--- Opposite relation side

  wallet             Wallet?
  payments           Payment[]
  walletTransactions WalletTransaction[]
  subscriptions      UserSubscription[]
  usageLogs          UsageLog[]

  // ========== ARTICLE RELATIONS ==========
  articles               Article[]
  articleComments        ArticleComment[]
  articleLikes           ArticleLike[]
  articleClaps           ArticleClap[]
  articleSaves           ArticleSave[]
  articleShares          ArticleShare[]
  articleViews           ArticleView[]
  commentLikes           CommentLike[]
  readingProfile         UserReadingProfile?
  articleRecommendations ArticleRecommendation[]
  searchHistories        SearchHistory[]
  userEngagements        UserEngagement[]
  PremiumAccess          PremiumAccess[]
  Notification           Notification[]
  Achievement            Achievement[]

  // ========== NOTIFICATION RELATIONS ==========
  sentNotifications    Notification[]            @relation("NotificationActor")
  notificationSettings UserNotificationSettings?

  resumeBuilderJobs ResumeBuilderJob[]


  // ========== CONTACT RELATIONS ==========
  contacts Contact[]
  
}

model Secrets {
  id                   String   @id @default(cuid())
  password             String?
  lastSignedIn         DateTime @default(now())
  verificationToken    String?
  twoFactorSecret      String?
  twoFactorBackupCodes String[] @default([])
  refreshToken         String?
  resetToken           String?  @unique
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, id])
}


// Add to models
model Contact {
  id        String        @id @default(cuid())
  name      String
  email     String
  subject   ContactSubject
  message   String        @db.Text
  status    ContactStatus @default(NEW)
  
  userId    String?
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  ipAddress String?
  userAgent String?
  metadata  Json?         @default("{}")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  respondedAt DateTime?
  
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([subject])
  
  @@map("contacts")
}

model ResumeBuilderJob {
  id String @id @default(cuid())

  // User information
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Job tracking
  requestId      String          @unique
  sourceType     AIBuilderSource
  textLength     Int?
  characterCount Int?

  // AI Configuration
  aiModel            String?
  enhanceWithAI      Boolean @default(true)
  includeSuggestions Boolean @default(true)
  targetTemplate     String?

  // Cost and payment
  cost          Int     @default(0)
  coinsDeducted Int?
  transactionId String?

  // Status and results
  status       AIBuilderStatus @default(PENDING)
  errorMessage String?
  confidence   Float? // 0-1 confidence score
  needsReview  Boolean         @default(true)

  // Extracted sections
  extractedBasics    Boolean @default(false)
  extractedWork      Boolean @default(false)
  extractedEducation Boolean @default(false)
  extractedSkills    Boolean @default(false)
  extractedProjects  Boolean @default(false)

  // Result resume
  resultResumeId String?
  resultResume   Resume? @relation("AIBuilderResult", fields: [resultResumeId], references: [id])

  // Metadata
  metadata Json?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  // Indexes
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([sourceType])
  @@map("resume_builder_jobs")
}

model ResumeBuilderCost {
  id          String  @id @default(cuid())
  action      String  @unique // e.g., "text_extraction", "ai_building", "pdf_processing"
  baseCost    Int     @default(0)
  minCost     Int     @default(0)
  maxCost     Int     @default(100)
  description String?
  isActive    Boolean @default(true)

  // Additional configuration
  dependsOnLength  Boolean @default(false) // Whether cost depends on text length
  lengthMultiplier Float? // Multiplier per character/word
  lengthThresholds Json? // Different costs for different lengths

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("resume_builder_costs")
}

// Update CoverLetter model
model CoverLetter {
  id         String           @id @default(cuid())
  title      String
  slug       String
  content    Json
  style      CoverLetterStyle @default(Modern)
  visibility Visibility       @default(private)
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  isPublic   Boolean          @default(false)
  layout     String?

  // Translation support
  language     String        @default("en") // Language code
  originalId   String? // Points to original letter if this is a translation
  translations CoverLetter[] @relation("TranslationVersions")
  parent       CoverLetter?  @relation("TranslationVersions", fields: [originalId], references: [id])

  // Translation metadata in content
  // content should have: {..., translationInfo: {originalLanguage: "en", translatedFrom: "letter-123"}}

  @@unique([userId, id])
  @@unique([userId, slug])
  @@unique([userId, slug, language]) // Ensure unique slug per language
  @@index([userId])
  @@index([originalId])
  @@index([language])
}

enum CoverLetterStyle {
  Modern
  Traditional
  Executive
  Creative
  Minimalist
  Professional
  Academic
  Technical
}

model Resume {
  id         String      @id @default(cuid())
  title      String
  slug       String
  data       Json        @default("{}")
  visibility Visibility  @default(private)
  locked     Boolean     @default(false)
  metadata   Json?
  statistics Statistics?
  userId     String
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Translation relations
  ResumeTranslation ResumeTranslation[]

  // NEW: Relations for translation records
  originalTranslations ResumeTranslationRecord[] @relation("OriginalResume")
  translatedCopies     ResumeTranslationRecord[] @relation("TranslatedResume")

  aiBuilderJobs        ResumeBuilderJob[]     @relation("AIBuilderResult")
  ResumeTranslationJob ResumeTranslationJob[]

  @@unique([userId, id])
  @@unique([userId, slug])
  @@index(fields: [userId])
}

model Statistics {
  id        String   @id @default(cuid())
  views     Int      @default(0)
  downloads Int      @default(0)
  resumeId  String   @unique
  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resumeId, id])
}

// --- Wallet + Payments + Subscriptions + Usage (add to schema.prisma) ---

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions WalletTransaction[] @relation("WalletToTransactions")
}

model WalletTransaction {
  id          String            @id @default(cuid())
  walletId    String
  amount      Int
  type        TransactionType
  source      TransactionSource // <-- Add this field
  description String?
  metadata    Json?
  createdAt   DateTime          @default(now())

  wallet Wallet  @relation("WalletToTransactions", fields: [walletId], references: [id])
  User   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([walletId])
}

// Add this enum
enum TransactionSource {
  SUBSCRIPTION
  ONE_TIME_PURCHASE
  REFUND
  BONUS
  MANUAL_ADJUSTMENT
  SYSTEM
  AI_BUILDER
}

enum TransactionType {
  CREDIT
  DEBIT
}

model SubscriptionPlan {
  id          String       @id @default(cuid())
  name        String
  description String?
  price       Decimal
  coins       Int
  interval    PlanInterval // Change from String to PlanInterval
  features    Json?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  subscriptions UserSubscription[]

  @@map("subscription_plans")
}

enum PlanInterval {
  MONTHLY
  YEARLY
}

model UserSubscription {
  id                 String             @id @default(cuid())
  userId             String
  planId             String
  status             SubscriptionStatus // Change from String to SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]

  @@unique([userId, planId])
  @@map("user_subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PENDING
  FAILED
}

model Payment {
  id               String            @id @default(cuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider         PaymentProvider
  providerRef      String?
  amount           Decimal
  currency         String            @default("USD")
  status           PaymentStatus
  coinsGranted     Int?
  metadata         Json?
  subscriptionId   String? // Add this field
  userSubscription UserSubscription? @relation(fields: [subscriptionId], references: [id]) // Add this relation
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@map("payments")
}

enum PaymentProvider {
  MOMO
  ORANGE
  STRIPE
  PAYPAL
  FLUTTERWAVE
  PAYSTACK
  TRANZAK
  MOCK
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

model UsageLog {
  id        String      @id @default(cuid())
  userId    String
  action    UsageAction
  cost      Int
  metadata  Json?
  createdAt DateTime    @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum UsageAction {
  RESUME_DOWNLOAD
  COVERLETTER_DOWNLOAD
  AI_RESUME_ENHANCEMENT
  AI_LETTER_GENERATION
  TEMPLATE_PREMIUM
  AI_RESUME_BUILDER
}

// ========== ARTICLE SYSTEM ==========

// Add to your existing enums section
enum ArticleStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum ContentAccess {
  FREE
  PREMIUM
}

// Add translation status
enum TranslationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Dynamic categories managed from admin panel with auto ai translation
model ArticleCategory {
  id           String  @id @default(cuid())
  name         String
  slug         String  @unique
  description  String?
  icon         String?
  color        String?
  order        Int     @default(0)
  isActive     Boolean @default(true)
  articleCount Int     @default(0)

  // Translation fields
  autoTranslate      Boolean  @default(true)
  targetLanguages    String[] @default(["fr", "es", "de"])
  availableLanguages String[] @default(["en"])

  // Relations
  articles         Article[]
  favoredBy        UserReadingProfile[]
  translations     CategoryTranslation[]
  translationJobs  CategoryTranslationJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([order])
}

// Add Category Translation model
model CategoryTranslation {
  id        String                 @id @default(cuid())
  category  ArticleCategory        @relation(fields: [categoryId], references: [id])
  categoryId String
  language  String // ISO code: "fr", "es", "de", etc.

  // Translated fields
  name        String
  description String?
  slug        String // Translated slug

  // Translation metadata
  status       CategoryTranslationStatus @default(COMPLETED)
  translatedBy String                    @default("AI")
  aiModel      String?
  confidence   Float                     @default(0.95)
  attemptCount Int                       @default(0)

  // Quality control
  needsReview  Boolean   @default(false)
  qualityScore Int?      // 1-5 score

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, language])
  @@index([categoryId])
  @@index([language])
  @@index([status])
}

// Add Category Translation Job model
model CategoryTranslationJob {
  id             String                   @id @default(cuid())
  category       ArticleCategory          @relation(fields: [categoryId], references: [id])
  categoryId     String
  targetLanguage String
  status         CategoryTranslationStatus @default(PENDING)
  priority       Int                       @default(1)
  attemptCount   Int                       @default(0)
  errorMessage   String?

  // AI settings
  aiModel  String  @default("llama-3.3-70b-versatile")
  useCache Boolean @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  @@unique([categoryId, targetLanguage])
  @@index([categoryId])
  @@index([status])
  @@index([priority])
}

// Main article model - optimized for engagement
model Article {
  id        String  @id @default(cuid())
  slug      String  @unique
  title     String
  excerpt   String
  content   Json // Rich JSON from editor (TipTap/Lexical)
  plainText String? // For search & previews

  // Category (dynamic from admin panel)
  category   ArticleCategory @relation(fields: [categoryId], references: [id])
  categoryId String
  tags       String[]        @default([])

  // Access control
  accessType ContentAccess @default(FREE)
  coinPrice  Int           @default(0) // If using coins for premium

  // Author info
  author   User   @relation(fields: [authorId], references: [id])
  authorId String

  // Media
  coverImage    String?
  featuredImage String?

  // SEO & Metadata
  metaTitle       String?
  metaDescription String?
  keywords        String[] @default([])
  readingTime     Int      @default(5) // minutes

  // Status & Visibility
  status       ArticleStatus @default(DRAFT)
  isFeatured   Boolean       @default(false)
  isTrending   Boolean       @default(false)
  isEditorPick Boolean       @default(false)
  isPopular    Boolean       @default(false)

  featuredRanking Int    @default(3)
  trendingScore   Int    @default(50)
  contentType     String @default("STANDARD")
  readingLevel    String @default("INTERMEDIATE")
  timeToRead      Int    @default(5)

  // Engagement Metrics (Updated in real-time)
  viewCount       Int @default(0)
  uniqueViewCount Int @default(0)
  likeCount       Int @default(0)
  commentCount    Int @default(0)
  shareCount      Int @default(0)
  saveCount       Int @default(0)
  clapCount       Int @default(0) // Medium-style claps

  // Translation settings
  autoTranslate      Boolean  @default(true) // Auto-translate to other languages
  availableLanguages String[] @default(["en"]) // Languages this article is available in
  targetLanguages    String[] @default(["fr"]) // Target languages for auto-translation

  // Timestamps
  publishedAt    DateTime?
  scheduledFor   DateTime?
  lastTrendingAt DateTime?

  // Relations
  comments        ArticleComment[]
  likes           ArticleLike[]
  shares          ArticleShare[]
  saves           ArticleSave[]
  claps           ArticleClap[]
  views           ArticleView[]
  translations    ArticleTranslation[]
  translationJobs TranslationJob[]
  recommendations ArticleRecommendation[]
  userEngagements UserEngagement[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  PremiumAccess PremiumAccess[]

  @@index([slug])
  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([publishedAt])
  @@index([isFeatured])
  @@index([isTrending])
  @@index([viewCount])
  @@index([likeCount])
  @@index([accessType])
}

// Add to your schema.prisma - Update Notification model
enum NotificationType {
  LIKE
  COMMENT
  REPLY
  ACHIEVEMENT
  PREMIUM
  SYSTEM
  RECOMMENDATION
  DIGEST
  READING_MILESTONE
  ARTICLE_PUBLISHED
  COMMENT_REPLY
  MENTION
}

model Notification {
  id String @id @default(cuid())

  // User who receives the notification
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  type    NotificationType
  title   String
  message String

  // Actor (who triggered the notification)
  actorId String?
  actor   User?   @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  // Target (what the notification is about)
  targetType  String? // 'ARTICLE', 'COMMENT', 'USER', 'ACHIEVEMENT'
  targetId    String?
  targetTitle String? // For quick display
  targetSlug  String? // For navigation

  // Additional data
  metadata Json @default("{}")

  // Read status
  read   Boolean   @default(false)
  readAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([userId])
  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([type])
  @@index([createdAt])
}

// Add this model for notification preferences
model UserNotificationSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email preferences
  emailArticleLikes        Boolean @default(true)
  emailArticleComments     Boolean @default(true)
  emailCommentReplies      Boolean @default(true)
  emailAchievements        Boolean @default(true)
  emailReadingDigest       Boolean @default(true)
  emailRecommendations     Boolean @default(true)
  emailSystemAnnouncements Boolean @default(true)

  // Push notification preferences
  pushArticleLikes      Boolean @default(true)
  pushArticleComments   Boolean @default(true)
  pushCommentReplies    Boolean @default(true)
  pushAchievements      Boolean @default(true)
  pushReadingMilestones Boolean @default(true)

  // Digest frequency
  digestFrequency String @default("WEEKLY") // DAILY, WEEKLY, MONTHLY, NEVER

  // Quiet hours
  quietStartHour Int @default(22) // 10 PM
  quietEndHour   Int @default(7) // 7 AM

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// PremiumAccess model (optional but recommended for tracking)
model PremiumAccess {
  id          String   @id @default(cuid())
  userId      String
  articleId   String
  amountPaid  Int      @default(0)
  accessUntil DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
  @@index([articleId])
  @@index([accessUntil])
}

// ========== TRANSLATION SYSTEM ==========

model ArticleTranslation {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id])
  articleId String
  language  String // ISO code: "fr", "es", "de", etc.

  // Translated content
  title     String
  excerpt   String
  content   Json // Translated rich content (same structure as original)
  plainText String?

  // SEO translations
  metaTitle       String?
  metaDescription String?
  keywords        String[] @default([])

  // Translation metadata
  status       TranslationStatus @default(COMPLETED)
  translatedBy String            @default("AI") // "AI", "HUMAN", "ADMIN"
  aiModel      String? // "gpt-4", "claude-3", etc.
  confidence   Float             @default(0.95)
  attemptCount Int               @default(0)

  // Quality control
  needsReview  Boolean   @default(false)
  contentHash  String?
  reviewedBy   String? // Admin who reviewed
  reviewedAt   DateTime?
  qualityScore Int? // 1-5 score

  // Performance & caching
  lastAccessed DateTime?
  accessCount  Int       @default(0)
  isCached     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([articleId, language])
  @@index([articleId])
  @@index([language])
  @@index([status])
  @@index([lastAccessed])
  @@index([needsReview])
}

// ========== ENGAGEMENT MODELS ==========

// Enhanced comments for articles
model ArticleComment {
  id        String           @id @default(cuid())
  content   String
  article   Article          @relation(fields: [articleId], references: [id])
  articleId String
  user      User             @relation(fields: [userId], references: [id])
  userId    String
  parentId  String? // For nested replies
  replies   ArticleComment[] @relation("CommentReplies")
  parent    ArticleComment?  @relation("CommentReplies", fields: [parentId], references: [id])

  // Language context (which translation was user reading?)
  language String @default("en")

  // Engagement
  likeCount  Int     @default(0)
  isEdited   Boolean @default(false)
  isPinned   Boolean @default(false)
  isFeatured Boolean @default(false) // Featured by admin

  // Moderation
  status      CommentStatus @default(ACTIVE)
  reported    Boolean       @default(false)
  reportCount Int           @default(0)

  // Relations
  likes CommentLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([articleId])
  @@index([userId])
  @@index([parentId])
  @@index([isFeatured])
  @@index([createdAt])
  @@index([language])
}

enum CommentStatus {
  ACTIVE
  DELETED
  HIDDEN
  PENDING_REVIEW
}

// Like system
model ArticleLike {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id])
  articleId String
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  language  String  @default("en") // Which language version they liked

  createdAt DateTime @default(now())

  @@unique([articleId, userId, language])
  @@index([articleId])
  @@index([userId])
}

// Medium-style claps
model ArticleClap {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id])
  articleId String
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  count     Int     @default(1) // User can clap multiple times
  language  String  @default("en")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([articleId, userId, language])
  @@index([articleId])
  @@index([userId])
}

// Save/Bookmark articles
model ArticleSave {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id])
  articleId String
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  folder    String? // "favorites", "read-later", custom folders
  language  String  @default("en") // Which language they saved

  createdAt DateTime @default(now())

  @@unique([articleId, userId, language])
  @@index([articleId])
  @@index([userId])
}

// Track shares for analytics
model ArticleShare {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id])
  articleId String
  user      User?   @relation(fields: [userId], references: [id])
  userId    String? // Nullable for anonymous shares
  platform  String // "facebook", "twitter", "whatsapp", "linkedin", "copy_link"
  shareUrl  String? // Unique tracking URL
  language  String  @default("en") // Which language they shared

  createdAt DateTime @default(now())

  @@index([articleId])
  @@index([userId])
  @@index([platform])
  @@index([createdAt])
}

// Track views for analytics
model ArticleView {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id])
  articleId String
  user      User?   @relation(fields: [userId], references: [id])
  userId    String? // Nullable for anonymous views
  ipAddress String?
  userAgent String?
  country   String?
  language  String  @default("en") // Which language they viewed

  createdAt DateTime @default(now())

  @@unique([articleId, userId, language], name: "articleId_userId_language_unique")
  @@index([articleId])
  @@index([userId])
  @@index([createdAt])
  @@index([language])
}

// Comment likes
model CommentLike {
  id        String         @id @default(cuid())
  comment   ArticleComment @relation(fields: [commentId], references: [id])
  commentId String
  user      User           @relation(fields: [userId], references: [id])
  userId    String

  createdAt DateTime @default(now())

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

// ========== TRANSLATION QUEUE ==========

model TranslationJob {
  id             String            @id @default(cuid())
  article        Article           @relation(fields: [articleId], references: [id])
  articleId      String
  targetLanguage String
  status         TranslationStatus @default(PENDING)
  priority       Int               @default(1) // 1-5, higher = more important

  // Job metadata
  attemptCount Int       @default(0)
  maxAttempts  Int       @default(3)
  errorMessage String?
  startedAt    DateTime?
  completedAt  DateTime?

  // AI settings
  aiModel  String  @default("gpt-4")
  useCache Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([articleId, targetLanguage])
  @@index([articleId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ========== PERSONALIZATION & RECOMMENDATIONS ==========

// User reading preferences and history
model UserReadingProfile {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  // Preferred categories (auto-detected from reading history)
  favoriteCategories ArticleCategory[]
  favoriteTags       String[]          @default([])

  // Reading habits
  averageReadingTime        Int       @default(0) // seconds
  preferredReadingTimeOfDay String? // "morning", "afternoon", "evening" - RENAMED
  preferredSessionDuration  Int? // minutes - NEW FIELD for session length
  readingStreak             Int       @default(0) // consecutive days
  lastReadAt                DateTime?

  // Content preferences
  preferredContentType String? // "articles", "guides", "videos"
  difficultyPreference String  @default("intermediate") // "beginner", "intermediate", "advanced"

  // Notification preferences
  notifyNewArticles  Boolean @default(true)
  notifyTrending     Boolean @default(true)
  notifyPersonalized Boolean @default(true)
  digestFrequency    String  @default("weekly") // "daily", "weekly", "none"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Article recommendations for users
model ArticleRecommendation {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  article   Article @relation(fields: [articleId], references: [id])
  articleId String

  // Recommendation algorithm data
  score  Float // 0-1 confidence score
  reason RecommendationReason // Why recommended
  source String               @default("CONTENT_BASED") // "CONTENT_BASED", "COLLABORATIVE", "POPULAR", "TRENDING"

  // User interaction with recommendation
  shownAt     DateTime?
  clickedAt   DateTime?
  dismissedAt DateTime?
  feedback    FeedbackType? // "liked", "not_interested"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, articleId])
  @@index([userId])
  @@index([articleId])
  @@index([score])
  @@index([createdAt])
}

enum RecommendationReason {
  SIMILAR_TO_HISTORY
  POPULAR_IN_CATEGORY
  TRENDING_NOW
  SIMILAR_USERS_LIKED
  BASED_ON_SEARCH
  EDITORS_PICK
  COMPLEMENTARY_SKILL
  CAREER_PATH
}

enum FeedbackType {
  LIKED
  NOT_INTERESTED
  ALREADY_READ
  NOT_RELEVANT
}

// User search history for recommendations
model SearchHistory {
  id      String @id @default(cuid())
  user    User   @relation(fields: [userId], references: [id])
  userId  String
  query   String
  results Int    @default(0)
  filters Json? // Search filters used

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([query])
  @@index([createdAt])
}

// Track what users click/engage with
model UserEngagement {
  id        String           @id @default(cuid())
  user      User             @relation(fields: [userId], references: [id])
  userId    String
  article   Article?         @relation(fields: [articleId], references: [id])
  articleId String?
  action    EngagementAction
  metadata  Json? // Additional data
  sessionId String? // For session tracking

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([articleId])
  @@index([action])
  @@index([createdAt])
}

enum EngagementAction {
  VIEW
  READ_COMPLETE
  LIKE
  COMMENT
  SHARE
  SAVE
  CLICK_RECOMMENDATION
  DISMISS_RECOMMENDATION
}

model Achievement {
  id            String    @id @default(cuid())
  userId        String
  title         String
  description   String
  icon          String
  badgeColor    String
  rarity        String // COMMON, RARE, EPIC, LEGENDARY
  category      String // READING, ENGAGEMENT, COMMUNITY, PREMIUM, MILESTONE
  points        Int
  unlocked      Boolean   @default(false)
  unlockedAt    DateTime?
  progress      Int       @default(0)
  totalRequired Int
  shareable     Boolean   @default(true)
  shareImage    String?
  shareText     String?
  shareUrl      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, title])
  @@index([userId])
  @@index([userId, unlocked])
}

// prisma/schema.prisma - Add these models
model ResumeTranslation {
  id           String            @id @default(cuid())
  resumeId     String
  language     String
  data         Json // Translated resume data
  status       TranslationStatus @default(PENDING)
  confidence   Float? // AI confidence score 0-1
  needsReview  Boolean           @default(false)
  translatedBy String? // 'ai' or 'manual'
  aiModel      String?
  attemptCount Int               @default(0)
  error        String?
  qualityScore Int? // 1-5 score
  totalTokens  Int? // For cost tracking

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastAccessed DateTime? // For caching optimization

  // Foreign keys
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([resumeId, language])
  @@index([resumeId])
  @@index([language])
  @@index([status])
  @@index([updatedAt])
}

model ResumeTranslationJob {
  id             String            @id @default(cuid())
  resumeId       String
  targetLanguage String
  status         TranslationStatus @default(PENDING)
  aiModel        String?
  priority       Int               @default(1) // 1-5, higher is more urgent
  attemptCount   Int               @default(0)
  errorMessage   String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  // Foreign keys
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([resumeId, targetLanguage])
  @@index([resumeId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

model ResumeTranslationRecord {
  id                 String  @id @default(cuid())
  originalResumeId   String
  translatedResumeId String
  language           String
  confidence         Float?
  needsReview        Boolean @default(false)
  aiModel            String?
  totalTokens        Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - UPDATED relation names
  originalResume   Resume @relation("OriginalResume", fields: [originalResumeId], references: [id], onDelete: Cascade)
  translatedResume Resume @relation("TranslatedResume", fields: [translatedResumeId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([originalResumeId, translatedResumeId])
  @@unique([translatedResumeId]) // Each translated resume can only have one original
  @@index([originalResumeId])
  @@index([translatedResumeId])
  @@index([language])
}
